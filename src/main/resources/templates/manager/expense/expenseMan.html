<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Quản lý chi tiêu</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" th:href="@{/css/sidebar.css}">
  <style>
    .content {
      margin-left: 250px;
      padding: 80px 20px 20px;
      transition: margin-left 0.3s ease;
    }
    .content.collapsed {
      margin-left: 60px;
    }
    h2 {
      text-align: center;
      margin: 20px 0;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .controls input[type="text"],
    .controls input[type="date"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .controls input[type="text"] {
      width: 300px;
    }
    .controls input[type="date"] {
      width: 150px;
    }
    .table-hover {
      width: 100%;
      border-collapse: collapse;
    }
    .table-hover th, .table-hover td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .table-hover tr:hover {
      background-color: #f1f1f1;
    }
    .table-hover th {
      background-color: #f2f2f2;
      cursor: pointer;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }
    .pagination button {
      padding: 10px 15px;
      margin: 0 5px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
      cursor: pointer;
      border-radius: 4px;
    }
    .pagination button.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .pagination button:disabled {
      cursor: not-allowed;
      background-color: #f1f1f1;
    }
    .pagination .ellipsis {
      padding: 10px 15px;
      margin: 0 5px;
      border: none;
      background: none;
      cursor: default;
    }
  </style>
</head>
<body>
<div th:insert="fragments/sidebar :: sidebar-manager (page = 'expense')"></div>

<div class="content" id="content">
  <div class="container-fluid container-table">
    <h2>DANH MỤC CHI TIÊU</h2>

    <div class="controls">
      <button style="display: none" id="fetchDelivery" type="button">Fetch Delivery Details</button>
      <input type="date" id="searchDate" placeholder="Search by Date">
      <input type="search" id="searchInput" placeholder="Search now" style="width: 500px">
    </div>
    <table class="table-hover">
      <thead>
      <tr>
        <th>ID</th>
        <th id="sortDeliveryDate">Ngày giao</th>
        <th>Tên nguyên liệu</th>
        <th>Số lượng</th>
        <th>Ngày hết hạn</th>
        <th>Đơn giá</th>
        <th>Tổng chi phí</th>
        <th>Nhà cung cấp</th>

      </tr>
      </thead>
      <tbody id="table-body">
      </tbody>
    </table>
    <button class="btn btn-success mb-2 bbb" style="margin-top: 10px"><a th:href="@{/manager/expense/add}" class="text-white text-decoration-none"><i class="bi bi-plus-circle"></i> THÊM </a></button>

    <div class="pagination" id="pagination-controls">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.getElementById('toggle-sidebar').addEventListener('click', function() {
    var sidebar = document.getElementById('sidebar');
    var content = document.getElementById('content');
    sidebar.classList.toggle('collapsed');
    content.classList.toggle('collapsed');
  });

  document.addEventListener('DOMContentLoaded', function() {
    var submenuToggles = document.querySelectorAll('.has-submenu > a');
    submenuToggles.forEach(function(submenuToggle) {
      submenuToggle.addEventListener('click', function(e) {
        e.preventDefault();
        var submenu = this.nextElementSibling;
        submenu.classList.toggle('open');
      });
    });
  });

  let currentPage = 1;
  const rowsPerPage = 20;
  let expenses = [];

  document.getElementById('fetchDelivery').addEventListener('click', function() {
    location.reload();
  });

  document.getElementById('searchInput').addEventListener('input', function() {
    currentPage = 1;
    displayTable();
    setupPagination();
  });

  document.getElementById('searchDate').addEventListener('input', function() {
    currentPage = 1;
    displayTable();
    setupPagination();
  });

  function displayTable() {
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = '';

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const searchDate = document.getElementById('searchDate').value;

    const filteredExpenses = expenses.filter(expense => {
      const matchesSearchTerm = Object.values(expense).some(val =>
              val && val.toString().toLowerCase().includes(searchTerm)
      );
      const matchesSearchDate = searchDate ?
              new Date(expense.purchaseDate).toISOString().split('T')[0] === searchDate : true;
      return matchesSearchTerm && matchesSearchDate;
    });

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedExpenses = filteredExpenses.slice(start, end);

    paginatedExpenses.forEach(expense => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${expense.expenseId}</td>
        <td>${expense.purchaseDate}</td>
        <td>${expense.ingredientName}</td>
        <td>${expense.quantity}</td>
        <td>${expense.expirationDate}</td>
        <td>${formatCurrency(expense.unitPrice) + "đ"}</td>
        <td>${formatCurrency(expense.totalPrice) + "đ"}</td>
        <td>${expense.supplier}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  function formatCurrency(amount) {
    return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function setupPagination() {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = '';

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const searchDate = document.getElementById('searchDate').value;

    const filteredExpenses = expenses.filter(expense => {
      const matchesSearchTerm = Object.values(expense).some(val =>
              val && val.toString().toLowerCase().includes(searchTerm)
      );
      const matchesSearchDate = searchDate ?
              new Date(expense.purchaseDate).toISOString().split('T')[0] === searchDate : true;
      return matchesSearchTerm && matchesSearchDate;
    });

    const totalPages = Math.ceil(filteredExpenses.length / rowsPerPage);

    const createButton = (text, isActive, isDisabled, page) => {
      const button = document.createElement('button');
      button.textContent = text;
      if (isActive) button.classList.add('active');
      if (isDisabled) button.disabled = true;
      if (page !== undefined) {
        button.addEventListener('click', function () {
          currentPage = page;
          displayTable();
          setupPagination();
        });
      }
      return button;
    };

    if (totalPages <= 7) {
      for (let i = 1; i <= totalPages; i++) {
        paginationControls.appendChild(createButton(i, i === currentPage, false, i));
      }
    } else {
      paginationControls.appendChild(createButton(1, currentPage === 1, false, 1));
      if (currentPage > 4) {
        paginationControls.appendChild(createButton('...', false, true));
      }

      for (let i = Math.max(2, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
        paginationControls.appendChild(createButton(i, i === currentPage, false, i));
      }

      if (currentPage < totalPages - 3) {
        paginationControls.appendChild(createButton('...', false, true));
      }
      paginationControls.appendChild(createButton(totalPages, currentPage === totalPages, false, totalPages));
    }
  }

  window.onload = function () {
    fetch('http://localhost:8080/api/expense')
            .then(response => response.json())
            .then(data => {
              expenses = data;
              displayTable();
              setupPagination();
            })
            .catch(error => {
              console.error('Error fetching expense details:', error);
            });
  };
</script>
</body>
</html>
