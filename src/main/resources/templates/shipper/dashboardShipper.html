<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link rel="stylesheet" href="path/to/font-awesome/css/font-awesome.min.css" />
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/dashboardshipper.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" th:href="@{/css/sidebar.css}">

  <style>
    .content {
      margin-left: 250px;
      padding: 50px 20px 20px;
      transition: margin-left 0.3s ease;
    }
    .content.collapsed {
      margin-left: 60px;
    }
    .content-wrapper {
      background-color: #ffffff;
      border-radius: 5px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-top: 60px;
    }
    .dashboard-shipper {
      display: flex;
      justify-content: space-evenly;
      margin: 30px;
      width: calc(100%-250px);
    }
    .dashboard-shipper .dashboard-shipper-box {
      width: 22%;
      height: 130px;
      box-shadow: 0 0 5px rgba(48, 46, 46, 0.5);
      text-align: center;
      /*padding: 10px;*/
    }
    .dashboard-shipper .dashboard-shipper-box p {
      color: #787878;
      font-family:  Roboto, sans-serif;
      font-size: 14px;
      font-weight: bold;
      margin-top: 8px;
    }


   */
    .btn-edit {
      background-color: green;
    }
    .btn-edit:hover {
      background-color: rgb(12, 154, 12);
    }
    .btn-delete {
      background-color: rgb(205, 23, 23);
    }
    .btn-delete:hover {
      background-color: rgba(248, 12, 12, 0.945);
    }
    .dashboard-shipper-chart {
      margin: 20px auto;
      width: 95%;
      background-color: #ffffff;
      padding: 20px;
    }

    .custom-form {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    .custom-form input[type="number"] {
      max-width: 120px;
    }
    .dashboard-shipper-number {
      width: 100%;
    }
    .dashboard-shipper-number h1, .dashboard-shipper-number i {
      flex-grow: 1;
      text-align: center;
    }

  </style>
</head>
<body>
<div th:insert="fragments/sidebar :: sidebar-shipper (page ='shipper') "  ></div>

<div class="content" id="content">
  <div class="content-wrapper">
    <div class="">
      <h3 class="delivery-manager-h2">DASHBOARD</h3>
      <svg style="width: 70px; margin-top: -60px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="#0e955b" d="M32 416c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H32z"/></svg>
    </div>

      <div class="dashboard-shipper">
        <div class="dashboard-shipper-box">
          <p class="dashboard-shipper-title">ĐƠN CHƯA GIAO</p>
          <div class="dashboard-shipper-number d-flex justify-content-center align-items-center">
            <h1 id="total-orders" class="me-3 ms-0" style="color: #4d84e2"></h1>
            <i class="bi bi-card-checklist opt-head ms-3 fs-1"></i>
          </div>

        </div>
        <div class="dashboard-shipper-box">
          <p class="dashboard-shipper-title">ĐƠN ĐANG GIAO</p>
          <div class="dashboard-shipper-number d-flex justify-content-center align-items-center">
            <h1 id="order-today" class="me-3 ms-0" style="color: #F8B934"></h1>
            <i class="bi bi-truck opt-head ms-3 fs-1"></i>
          </div>
        </div>
        <div class="dashboard-shipper-box">
          <p class="dashboard-shipper-title">ĐƠN THÀNH CÔNG</p>
          <div  class="dashboard-shipper-number d-flex justify-content-center align-items-center">
            <h1 id="order-success" class="me-3 ms-0" style="color: #1e7e34"></h1>
            <i class="bi bi-check-circle opt-head ms-3 fs-1"></i>
          </div>
        </div>
        <div class="dashboard-shipper-box">
          <p class="dashboard-shipper-title">ĐƠN THẤT BẠI</p>
          <div  class="dashboard-shipper-number d-flex justify-content-center align-items-center">
            <h1 id="order-cancel" class="me-3 ms-0" style="color: #cd1524"></h1>
            <i class="bi bi-x-circle opt-head ms-3 fs-1"></i>
          </div>
        </div>
    </div>
      <div class="dashboard-shipper-chart">
        <form id="searchForm" class="custom-form">
          <label for="search-year" class="form-label" style="color: #1e7e34; font-weight: bold">Select Year:</label>
          <input type="number" id="search-year" name="search-year" min="1900" max="" class="form-control" placeholder="YYYY">
          <button type="submit" class="btn btn-primary" style="background-color: #1e7e34">Search</button>
        </form>
      <canvas id="barchart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script>
  document.getElementById('toggle-sidebar-shipper').addEventListener('click', function() {
    var sidebar = document.getElementById('sidebar_shipper');
    var content = document.getElementById('content');
    sidebar.classList.toggle('collapsed');
    content.classList.toggle('collapsed');
  });

  document.addEventListener('DOMContentLoaded', function() {
    var submenuToggles = document.querySelectorAll('.has-submenu > a');
    submenuToggles.forEach(function(submenuToggle) {
      submenuToggle.addEventListener('click', function(e) {
        e.preventDefault();
        var submenu = this.nextElementSibling;
        submenu.classList.toggle('open');
      });
    });
  });
  document.addEventListener("DOMContentLoaded", function () {
    const labels = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
    const data = {
      labels: labels,
      datasets: [
        {
          label: 'Success',
          data: [],
          backgroundColor: "rgba(75, 192, 192, 0.2)",
          borderColor: "rgba(75, 192, 192, 1)",
          borderWidth: 1,
          barThickness: 30,
          offset: 10,

        },
        {
          label: 'Cancel',
          data: [],
          backgroundColor: "rgba(255, 99, 132, 0.2)",
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 1,
          barThickness: 30,
          offset: 10,
        },
      ],
    };

    const config = {
      type: "bar",
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'Order Statistics by Month',
            font: {
              size: 20 // Điều chỉnh kích thước chữ ở đây
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            }
          },
          y: {
            beginAtZero: true,
          },
        },
      },
    };
    const barchart = new Chart(document.getElementById("barchart"), config);

    fetch('http://localhost:8080/api/delivery/shipper')
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              // Process the fetched data
              const NotyetDelivery=calculateNotYetDeliveryOrders(data);
              document.getElementById('total-orders').textContent = NotyetDelivery;
              const TodayOrders=calculateTodayOrders(data);
              document.getElementById('order-today').textContent = TodayOrders;
              const SuccessOrders=calculateSuccessOrders(data);
              document.getElementById('order-success').textContent = SuccessOrders;
              const CancelOrders=calculateCancelOrders(data);
              document.getElementById('order-cancel').textContent = CancelOrders;
              const tableBody = document.getElementById('dashboard-shipper-tbody');
              tableBody.innerHTML = '';
              data.forEach((delivery, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${index + 1}</td>
                <td>${delivery.deliveryId}</td>
                <td>${delivery.deliveryStatus}</td>
                <td>${delivery.deliveryTime}</td>
                <td>${formatDate(delivery.deliveryDate)}</td>
                <td>${delivery.customerFullName}</td>
                <td>${delivery.deliveryPhone}</td>
                <td>${delivery.deliveryAddress}</td>
                <td>${delivery.deliveryPrice}</td>
                <td>${delivery.shipperFullName}</td>
              `;
                tableBody.appendChild(row);
              });
            })
            .catch(error => console.error('Error fetching delivery data:', error));

    function formatDate(dateString) {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${day}/${month}/${year}`;
    }

    function fetchDataFromAPI(year) {
      return fetch(`http://localhost:8080/api/delivery/shipper?year=${year}`)
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              });
    }

    function updateChart(chart, dataSuccess, dataCancel) {
      chart.data.datasets[0].data = dataSuccess;
      chart.data.datasets[1].data = dataCancel;
      chart.update();
    }

    function calculateMonthlyData(data, year) {
      // Nếu year trống, thiết lập nó thành năm hiện tại
      const currentYear = new Date().getFullYear();
      year = year || currentYear;
      const monthlyDataSuccess = Array(12).fill(0);
      const monthlyDataCancel = Array(12).fill(0);

      data.forEach(order => {
        const orderDate = new Date(order.deliveryDate);
        const orderYear = orderDate.getFullYear();
        const orderMonth = orderDate.getMonth();

        if (orderYear === year) {
          if (order.deliveryStatus === "DELIVERED") {
            monthlyDataSuccess[orderMonth]++;
          } else if (order.deliveryStatus === "DELIVERY_FAILED") {
            monthlyDataCancel[orderMonth]++;
          }
        }
      });

      return { monthlyDataSuccess, monthlyDataCancel };
    }

    const currentYear = new Date().getFullYear();
    const yearInput = document.getElementById("search-year");
    yearInput.setAttribute('max', currentYear.toString());
    fetchDataFromAPI(currentYear)
            .then(data => {
              const { monthlyDataSuccess, monthlyDataCancel } = calculateMonthlyData(data, currentYear);
              updateChart(barchart, monthlyDataSuccess, monthlyDataCancel);
            })
            .catch(error => console.error('Error fetching data for chart:', error));

    // Event listener for the search form
    document.getElementById("searchForm").addEventListener("submit", function (event) {
      event.preventDefault();
      const year = parseInt(yearInput.value);
      if (isNaN(year) || year < 1900 || year > currentYear) {
        if (year < 1900) {
          alert("Please enter a valid year (1900 or later).");
        } else if (year > currentYear) {
          alert(`Please enter a valid year (${currentYear} or earlier).`);
        }
        return;
      }

      fetchDataFromAPI(year)
              .then(data => {
                const { monthlyDataSuccess, monthlyDataCancel } = calculateMonthlyData(data, year);
                updateChart(barchart, monthlyDataSuccess, monthlyDataCancel);
              })
              .catch(error => console.error('Error fetching data for chart:', error));
    });
  });


  function calculateNotYetDeliveryOrders(data) {
    return data.filter(order => order.deliveryStatus === 'NOT_DELIVERED').length;
  }
  function calculateTodayOrders(data) {
    const today = new Date().toISOString().split('T')[0];
    return data.filter(order => order.deliveryDate === 'IN_TRANSIT').length;
  }
  function calculateSuccessOrders(data) {
    return data.filter(order => order.deliveryStatus === 'DELIVERED').length;
  }
  function calculateCancelOrders(data) {
    return data.filter(order => order.deliveryStatus === 'DELIVERY_FAILED').length;
  }
</script>
</body>
</html>
