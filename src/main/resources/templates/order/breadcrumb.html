<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Giỏ hàng', 'none')}"></head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Giỏ hàng</title>
<link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
/>
<style>
    main.card-table {
        min-height: 100vh;
        padding: 20px;
        background: rgb(248, 247, 247);
    }

    table {
        width: 100%;
        border-spacing: 0 20px;
    }
    table thead,
    tbody {
        background-color: rgb(255, 255, 255);
    }
    table tr {
        border-radius: 3px;
        box-shadow: 0 0 1px rgba(175, 174, 174, 0.5);
    }
    table th,
    td {
        padding: 15px;
        text-align: center;
    }
    .card-contain-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
    }
    .card-contain-button input,
    .card-total-price-button input {
        width: 20px;
        height: 20px;
        border: 2px solid #333;
        border-radius: 4px;
        outline: none;
        accent-color: red;
    }
    .card-product {
        display: flex;
        align-items: center;
        justify-content: start;
    }
    .card-product img {
        width: 80px;
        height: 80px;
        border-radius: 5px;
        margin-right: 10px;
    }
    .card-product-name {
        font-size: 20px;
        padding: 10px;
        font-family: "Lucida Sans", "Lucida Sans Regular", "Lucida Grande",
        "Lucida Sans Unicode", Geneva, Verdana, sans-serif;
    }
    .card-quantity {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .card-quantity input {
        width: 40px;
        text-align: center;
        border: 1px solid #cbc0c0;
        margin: 0 5px;
    }
    .card-quantity button {
        width: 30px;
        height: 30px;
        outline: none;
        background: none;
        border: 1px solid #cbc0c0;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    .card-quantity button:hover {
        background-color: #ececec;
    }
    .card-total-price table {
        border-spacing: 0 0;
        width: 100%;
    }
    .card-total-price table td {
        text-align: center;
    }
    .card-total-price-button {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .card-delete {
        cursor: pointer;
        color: #d9534f;
    }
    .card-delete:hover {
        text-decoration: underline;
    }
    .card-total-price-button label {
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .card-total-price-button input {
        margin-right: 5px;
    }
</style>

<header th:replace="~{fragments :: header-fragment}"></header>

<body>
<main class="card-table container mt-3 mb-3">
    <section class="card-table-header"><h1>Giỏ hàng</h1></section>
    <section class="card-table-body">
        <table>
            <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Đơn giá</th>
                <th>Số lượng</th>
                <th>Số tiền</th>
                <th>Thao tác</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="orderBasket : ${orderBaskets}">
                <td>
                    <div class="card-product">
                        <img th:src="${orderBasket.combo.comboImage}"/>
                        <div class="card-product-name" th:text="${orderBasket.combo.comboName}"></div>
                    </div>
                </td>
                <td>
                    <div class="card-price" th:if="${orderBasket.day} == 7" th:text="${orderBasket.combo.comboPrice7Days}"></div>
                    <div class="card-price" th:if="${orderBasket.day} == 30" th:text="${orderBasket.combo.comboPrice30Days}"></div>
                </td>

                <td>
                    <div class="card-quantity">
                        <button class="minus-btn">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                        <input type="text" id="amount" th:value="${orderBasket.quantity}" th:data-product-id="${orderBasket.orderBasketId}" />
                        <button class="plus-btn">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </td>
                <td>
                    <div class="card-totalmoney" th:if="${orderBasket.day} == 7" th:text="${orderBasket.subTotal7Days}"></div>
                    <div class="card-totalmoney"  th:if="${orderBasket.day} == 30" th:text="${orderBasket.subTotal30Days}"></div>
                </td>
                <td>
                    <a th:href="@{'/basket/remove/' + ${orderBasket.orderBasketId}}"
                       href="#"
                       onclick="if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này không?')) return false;"
                       class="text-danger mr-2 text-decoration-none">Xóa</a>
                </td>
            </tr>
            </tbody>
        </table>
    </section>
    <section class="card-total-price">
        <table>
            <tr>
                <td colspan="2"></td>
                <td><i class="bi bi-ticket-perforated"> NutriMeal Voucher</i></td>
                <td><button>Chọn hoặc nhập mã giảm giá</button></td>
            </tr>
            <tr>
                <td colspan="2"></td>
                <td>
                    <label for="xu">
                        <input type="checkbox" id="xu" name="xu" value="" />
                        <i class="bi bi-coin"> NutriMeal Xu</i>
                    </label>
                </td>
                <td>-0 VND</td>
            </tr>
            <tr>
                <!--                <td>-->
                <!--                    <div class="card-total-price-button">-->
                <!--                        <label for="all">-->
                <!--                            <input-->
                <!--                                    type="checkbox"-->
                <!--                                    id="all"-->
                <!--                                    name="all"-->
                <!--                                    value=""-->
                <!--                                    onclick="checkAll()"-->
                <!--                            />-->
                <!--                            Chọn tất cả-->
                <!--                        </label>-->
                <!--                    </div>-->
                <!--                </td>-->
                <td><div class="card-delete">Xóa</div></td>
                <td>Tổng thanh toán ():</td>
                <td><span>0 VND</span></td>
                <td>
                    <button
                            style="
                            width: 100%;
                            height: 40px;
                            background-color: rgb(249, 0, 21);
                            border: none;
                            border-radius: 3px;
                            color: #ececec;
                            font-size: 20px;
                        "
                    >
                        Thanh Toán
                    </button>
                </td>
            </tr>
        </table>
    </section>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const minusButtons = document.querySelectorAll('.minus-btn');
        const plusButtons = document.querySelectorAll('.plus-btn');
        const inputs = document.querySelectorAll('.card-quantity input');

        function updateTotal(input) {
            const tr = input.closest('tr');
            const priceElement = tr.querySelector('.card-price').innerText;
            const price = parseFloat(priceElement.replace(/[^0-9.-]+/g, ""));
            const quantity = parseInt(input.value);
            const totalElement = tr.querySelector('.card-totalmoney');
            totalElement.innerText = (price * quantity).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function updateQuantityInDB(productId, quantity) {
            $.ajax({
                url: '/update-quantity',
                method: 'POST',
                data: {
                    productId: productId,
                    quantity: quantity,
                    _csrf: $('input[name="_csrf"]').val()  // Nếu bạn sử dụng CSRF protection
                },
                success: function (response) {
                    console.log('Quantity updated successfully');
                },
                error: function (xhr) {
                    console.error('Error updating quantity');
                }
            });
        }

        minusButtons.forEach(button => {
            button.addEventListener('click', function () {
                const input = this.nextElementSibling;
                let value = parseInt(input.value);
                const productId = input.dataset.productId;
                if (!isNaN(value) && value > 1) {
                    value--;
                    input.value = value;
                    updateTotal(input);
                    updateQuantityInDB(productId, value);
                }
            });
        });

        plusButtons.forEach(button => {
            button.addEventListener('click', function () {
                const input = this.previousElementSibling;
                let value = parseInt(input.value);
                const productId = input.dataset.productId;
                if (!isNaN(value) && value < 100) {
                    value++;
                    input.value = value;
                    updateTotal(input);
                    updateQuantityInDB(productId, value);
                }
            });
        });

        inputs.forEach(input => {
            input.addEventListener('input', function () {
                let value = parseInt(this.value);
                const productId = this.dataset.productId;
                if (isNaN(value) || value < 1) {
                    this.value = 1;
                } else if (value > 100) {
                    this.value = 100;
                }
                updateTotal(this);
                updateQuantityInDB(productId, this.value);
            });
        });
    });
</script>

</body>

<footer th:replace="~{fragments :: footer}"></footer>

</html>