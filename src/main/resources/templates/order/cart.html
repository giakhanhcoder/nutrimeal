<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Giỏ hàng', 'none')}"></head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>gio hang</title>
<link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
/>
<style>
    main.card-table {
        min-height: 100vh;
        padding: 20px;
        background: rgb(248, 247, 247);
    }

    table {
        width: 100%;
        border-spacing: 0 20px;
    }
    table thead,
    tbody {
        background-color: rgb(255, 255, 255);
    }
    table tr {
        border-radius: 3px;
        box-shadow: 0 0 1px rgba(175, 174, 174, 0.5);
    }
    table th,
    td {
        padding: 15px;
    }
    .card-contain-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px; /* Kích thước chiều rộng của ô vuông */
        height: 30px; /* Kích thước chiều cao của ô vuông */
    }
    .card-contain-button input,
    .card-total-price-button input {
        width: 20px; /* Kích thước chiều rộng của checkbox */
        height: 20px; /* Kích thước chiều cao của checkbox */
        border: 2px solid #333; /* Đường viền của checkbox */
        border-radius: 4px; /* Đường cong viền của checkbox */
        outline: none; /* Loại bỏ đường viền xung quanh checkbox khi focus */
        accent-color: red;
    }
    .card-product {
        display: flex;
        align-items: center;
        width: 30%;
    }
    .card-product img {
        width: 80px;
        height: 80px;
        border-radius: 5px;
    }
    .card-product-name {
        font-size: 20px;
        padding: 20px;
        font-family: "Lucida Sans", "Lucida Sans Regular", "Lucida Grande",
        "Lucida Sans Unicode", Geneva, Verdana, sans-serif;
    }
    .card-quantity {
        display: flex;
    }
    .card-quantity input {
        width: 20px;
    }
    .card-quantity button {
        width: 20px;
        height: 20px;
        outline: none;
        background: none;
        border: 1px solid #cbc0c0;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    .card-quantity button:hover {
        background-color: #ececec;
    }
    #amount {
        width: 40px;
        text-align: center;
        border: 1px solid #cbc0c0;
    }
    .card-total-price table {
        border-spacing: 0 0;
    }
    .card-total-price table td {
        text-align: justify;
    }
</style>


<header th:replace="~{fragments :: header-fragment}"></header>


<body>
<main class="card-table">
    <section class="card-table-header">Giỏ hàng</section>
    <section class="card-table-body">
        <table>
            <thead>
            <tr>
                <th>
                    <div class="card-contain-button">
                        <label for="all">
                            <input
                                    type="checkbox"
                                    id="all"
                                    name="all"
                                    value=""
                                    onclick="checkAll()"
                            />
                        </label>
                    </div>
                </th>
                <th><div class="card-product">Sản phẩm</div></th>
                <th><div class="card-price">Đơn giá</div></th>
                <th><div class="card-quantity">Số lượng</div></th>
                <th><div class="card-totalmoney">Số tiền</div></th>
                <th><div class="card-activity">Thao tác</div></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="orderBasket : ${orderBaskets}">
                <td>
                    <div class="card-contain-button">
                        <label for="product">
                            <input
                                    type="checkbox"
                                    id="product"
                                    name="product"
                                    th:value="${orderBasket.orderBasketId}"
                            />
                        </label>
                    </div>
                </td>
                <td>
                    <div class="card-product">
                        <img
                              th:src="${orderBasket.combo.comboImage}"
                        />
                        <div class="card-product-name" th:text="${orderBasket.combo.comboName}"></div>
                    </div>
                </td>
                <td>
                    <div class="card-price"  th:if="${orderBasket.day} == 7" th:text="${orderBasket.combo.comboPrice7Days}"></div>
                    <div class="card-price"  th:if="${orderBasket.day} == 30" th:text="${orderBasket.combo.comboPrice30Days}"></div>
                </td>
                <td>
                    <div class="card-quantity">
                        <button class="minus-btn" >
                            <i class="bi bi-dash-lg"></i>
                        </button>
                        <input type="text" id="amount" th:value="${orderBasket.quantity}" th:data-product-id="${orderBasket.orderBasketId}" />
<!--                        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />-->
                        <button class="plus-btn" >
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </td>
                <td>
                    <div class="card-totalmoney" th:if="${orderBasket.day} == 7" th:text="${orderBasket.subTotal7Days}"></div>
                    <div class="card-totalmoney"  th:if="${orderBasket.day} == 30" th:text="${orderBasket.subTotal30Days}"></div>
                </td>

                <td><div class="card-activity">Xóa sản phẩm</div></td>
            </tr>
            </tbody>
        </table>
    </section>
    <section class="card-total-price">
        <table>
            <tr>
                <td></td>
                <td></td>
                <td style="width: 20%">
                    <i class="bi bi-ticket-perforated"> NutriMeal Voucher</i>
                </td>
                <td style="width: 20%">
                    <buton>Chọn hoặc nhập mã giảm giá</buton>
                </td>
            </tr>
            <tr>
                <td style="width: 20%"></td>
                <td></td>
                <td style="width: 20%">
                    <label for="xu">
                        <input type="checkbox" id="xu" name="xu" value=""
                        /></label>
                    <i class="bi bi-coin"> NutriMeal Xu</i>
                </td>
                <td style="width: 20%">-0</td>
            </tr>
            <tr>
                <td>
                    <div class="card-total-price-button">
                        <label for="all">
                            <input
                                    type="checkbox"
                                    id="all"
                                    name="all"
                                    value=""
                                    onclick="checkAll()"
                            />
                            Chọn tất cả
                        </label>
                    </div>
                </td>
                <td><div class="card-delete">Xóa</div></td>
                <td style="width: 20%">
                    <p>Tổng thanh toán ():<span>0đ</span></p>
                </td>
                <td style="width: 20%">
                    <button
                            style="
                  width: 100%;
                  height: 40px;
                  background-color: rgb(249, 0, 21);
                  border: none;
                  border-radius: 3px;
                  color: #ececec;
                  font-size: 20px;
                "
                    >
                        Thanh Toán
                    </button>
                </td>
            </tr>
        </table>
    </section>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const minusButtons = document.querySelectorAll('.minus-btn');
        const plusButtons = document.querySelectorAll('.plus-btn');
        const inputs = document.querySelectorAll('.card-quantity input');

        function updateTotal(input) {
            const tr = input.closest('tr');
            const priceElement = tr.querySelector('.card-price').innerText;
            const price = parseFloat(priceElement.replace(/[^0-9.-]+/g,""));
            const quantity = parseInt(input.value);
            const totalElement = tr.querySelector('.card-totalmoney');
            totalElement.innerText = (price * quantity).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function updateQuantityInDB(productId, quantity) {
            $.ajax({
                url: '/update-quantity',
                method: 'POST',
                data: {
                    productId: productId,
                    quantity: quantity,
                    _csrf: $('input[name="_csrf"]').val()  // Nếu bạn sử dụng CSRF protection
                },
                success: function(response) {
                    console.log('Quantity updated successfully');
                },
                error: function(xhr) {
                    console.error('Error updating quantity');
                }
            });
        }


        minusButtons.forEach(button => {
            button.addEventListener('click', function () {
                const input = this.nextElementSibling;
                let value = parseInt(input.value);
                const productId = input.dataset.productId;
                if (!isNaN(value) && value > 1) {
                    value--;
                    input.value = value;
                    updateTotal(input);
                    updateQuantityInDB(productId, value);
                }
            });
        });

        plusButtons.forEach(button => {
            button.addEventListener('click', function () {
                const input = this.previousElementSibling;
                let value = parseInt(input.value);
                const productId = input.dataset.productId;
                if (!isNaN(value) && value < 100) {
                    value++;
                    input.value = value;
                    updateTotal(input);
                    updateQuantityInDB(productId, value);
                }
            });
        });

        inputs.forEach(input => {
            input.addEventListener('input', function () {
                let value = parseInt(this.value);
                const productId = this.dataset.productId;
                if (isNaN(value) || value < 1) {
                    this.value = 1;
                } else if (value > 100) {
                    this.value = 100;
                }
                updateTotal(this);
                updateQuantityInDB(productId, this.value);
            });
        });
    });
</script>


</body>

<footer th:replace="~{fragments :: footer}"></footer>

</html>